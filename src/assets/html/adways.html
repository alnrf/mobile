
<!DOCTYPE html>
<html>
  <head>
    <title>Test webview adways pour mobile</title>
    <style type="text/css">
      body {
        background-color: transparent;
      }
    </style>
  </head>
  <body id="webview-div">
    <div id="container">
      <button id="button" onclick="clickHandler();" >Send to RN</button>
    </div>
    <script type="text/javascript" src="//dj5ag5n6bpdxo.cloudfront.net/libs/interactive/loader.js"></script>
    <script type="text/javascript">
      var experience = new adways.interactive.Experience();
      experience.setPublicationID('mpNHyTH');
      experience.setPlayerAPI(document.getElementById('webview-div'));
      // experience.setPlayerAPI(document.window);
      experience.setPlayerClass('coorpwebview');
      experience.load();
    </script>
    <script>
      var promiseChain = Promise.resolve();
    	var callbacks = {};

    	var init = function() {
    		const guid = function() {
    			function s4() {
    				return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
    			}
    			return s4() + s4() + "-" + s4() + "-" + s4() + "-" + s4() + "-" + s4() + s4() + s4();
    		}

    		window.webViewBridge = {
    			/**
    			 * send message to the React-Native WebView onMessage handler
    			 * @param targetFunc - name of the function to invoke on the React-Native side
    			 * @param data - data to pass
    			 * @param success - success callback
    			 * @param error - error callback
    			 */
    			send: function(targetFunc, data, success, error) {
    				var msgObj = {
    					targetFunc: targetFunc,
    					data: data || {}
    				};
    				if (success || error) {
    					msgObj.msgId = guid();
    				}
    				var msg = JSON.stringify(msgObj);
    				promiseChain = promiseChain.then(function () {
    					return new Promise(function (resolve, reject) {
    						console.log("sending message " + msgObj.targetFunc);
    						if (msgObj.msgId) {
    							callbacks[msgObj.msgId] = {
    								onsuccess: success,
    								onerror: error
    							};
    						}
    						window.ReactNativeWebView.postMessage(msg);
    						resolve();
    					})
    				}).catch(function (e) {
    					console.error('rnBridge send failed ' + e.message);
    				});
    			},
    		};

    		window.addEventListener('message', function(e) {
    			console.log("message received from react native");
    			var message;
    			try {
    				message = JSON.parse(e.data)
    			}
    			catch(err) {
    				console.error("failed to parse message from react-native " + err);
    				return;
    			}
    			//trigger callback
    			if (message.args && callbacks[message.msgId]) {
    				if (message.isSuccessfull) {
    					callbacks[message.msgId].onsuccess.apply(null, message.args);
    				}
    				else {
    					callbacks[message.msgId].onerror.apply(null, message.args);
    				}
    				delete callbacks[message.msgId];
    			}
    		});
    	};

    	init();

      window.counter = 0;
      function clickHandler() {
      	window.counter++;
        window.webViewBridge.send(
          'handleDataReceived',
          window.counter,
          function(res) {
            window.document.getElementById("button").setAttribute("style", "background-color: " + res);
          },
          function(err) {
			      window.document.getElementById("container").setAttribute("style", "background-color: " + err);
          }
        );
      }
    </script>
  </body>
</html>
